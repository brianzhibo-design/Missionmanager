# 任务管理系统

基于 AI 增强的智能任务管理系统。

## 项目结构

```
任务管理系统/
├── backend/               # 后端服务
│   └── src/
│       ├── controllers/   # HTTP 控制器
│       ├── services/      # 业务逻辑层
│       ├── repositories/  # 数据访问层
│       ├── ai/            # AI 分析模块
│       ├── domain/        # 领域模型
│       └── infra/         # 基础设施
├── frontend/              # 前端应用
├── docker/                # Docker 配置
└── docs/                  # 项目文档
```

## 技术栈

### 后端
- Node.js + TypeScript
- Express.js
- Prisma ORM
- PostgreSQL
- Anthropic Claude API (AI 功能)

### 前端
- Vite + React
- TypeScript
- React Router
- Lucide React (图标库)

### 基础设施
- Docker & Docker Compose
- PostgreSQL
- Redis（可选）

## 快速开始

### 1. 启动数据库服务

```bash
cd docker
docker-compose up -d
```

### 2. 启动后端服务

```bash
cd backend
npm install
npm run dev
```

### 3. 启动前端应用

```bash
cd frontend
npm install
npm run dev
```

## 环境变量

复制 `.env.example` 为 `.env` 并配置相应的环境变量。

---

## 更新日志

### 2024-12-16 更新

#### 🎯 项目权限控制与成员任务树优化

##### 1. 项目权限控制
| 角色 | 项目可见范围 |
|------|-------------|
| **owner / director / manager** | 可查看工作区内所有项目 |
| **member / observer（同事/协作者）** | 仅可查看自己参与的项目 |

> "参与项目" = 作为项目负责人 **或** 项目团队成员

##### 2. 新建项目功能增强
| 功能 | 描述 |
|------|------|
| **指定项目负责人** | 创建项目时可选择负责人，负责人可管理项目设置和推进任务 |
| **添加团队成员** | 创建项目时可勾选多个团队成员，成员可创建和参与项目任务 |
| **成员角色显示** | 显示成员在工作区中的角色标签（owner/director/manager/member/observer） |

##### 3. 成员任务树优化
| 优化项 | 描述 |
|--------|------|
| **工作区信息显示** | 顶部显示当前工作区名称 |
| **项目信息显示** | 显示项目名称（移除冗长的项目描述） |
| **项目负责人展示** | 金色高亮卡片显示负责人姓名和邮箱 |
| **团队成员列表** | 显示所有项目成员及其角色标签 |
| **成员任务分布树** | 树形结构显示每个成员的任务统计 |
| **成员详情面板** | 点击成员可查看详细任务列表 |

#### 📁 更新文件清单

##### 后端 (backend/)

| 文件 | 更新内容 |
|------|----------|
| `src/types/tree.ts` | • 新增 `ProjectLeaderInfo` 接口<br>• 新增 `ProjectTeamMember` 接口<br>• 扩展 `MemberTreeResponse` 包含工作区/负责人/团队成员信息 |
| `src/services/projectService.ts` | • `create()` 支持 leaderId 和 teamMemberIds<br>• `getByWorkspace()` 实现角色权限过滤<br>• 新增 `getProjectRole()` 方法 |
| `src/services/treeService.ts` | • `getMemberTree()` 返回完整项目团队信息<br>• 包含工作区名称、负责人、团队成员列表 |
| `src/repositories/projectRepository.ts` | • 新增 `findByWorkspaceIdForMember()` 按成员过滤项目<br>• 优化 `findByIdWithTeam()` 包含负责人和成员 |
| `src/controllers/projectController.ts` | • `POST /projects` 支持 leaderId 和 teamMemberIds 参数 |

##### 前端 (frontend/)

| 文件 | 更新内容 |
|------|----------|
| `src/services/tree.ts` | • 新增 `ProjectLeaderInfo` 接口<br>• 新增 `ProjectTeamMember` 接口<br>• 更新 `MemberTreeResponse` 类型 |
| `src/services/workspace.ts` | • 新增 `getMembers()` 获取工作区成员列表<br>• 新增 `WorkspaceMember` 接口 |
| `src/services/project.ts` | • `createProject()` 支持 leaderId 和 teamMemberIds |
| `src/pages/Projects.tsx` | • 新建项目弹窗增加负责人下拉选择<br>• 新建项目弹窗增加团队成员复选框 |
| `src/pages/Projects.css` | • 新增团队成员选择器样式 |
| `src/pages/admin/MembersTree.tsx` | • 新增项目信息卡片（工作区/项目/团队）<br>• 负责人金色高亮显示<br>• 团队成员列表及角色标签 |
| `src/pages/admin/MembersTree.css` | • 新增项目信息卡片样式<br>• 负责人卡片金色渐变背景<br>• 团队成员列表样式 |

#### 🖼️ 功能截图说明

**1. 新建项目（含负责人和团队选择）**
```
┌─────────────────────────────────────────────────────┐
│ 新建项目                                         ✕  │
├─────────────────────────────────────────────────────┤
│ 项目名称 *                                          │
│ [________________________]                          │
│                                                     │
│ 描述                                                │
│ [________________________]                          │
│                                                     │
│ 项目负责人                                          │
│ [选择负责人（可选）        ▼]                       │
│ 负责人可以管理项目设置和推进任务                     │
│                                                     │
│ 团队成员                                            │
│ ┌─────────────────────────────────────────────────┐ │
│ │ ☐ 王明      director                            │ │
│ │ ☐ 李华      manager                             │ │
│ │ ☐ 张伟      member                              │ │
│ │ ☐ 刘芳      observer                            │ │
│ └─────────────────────────────────────────────────┘ │
│ 团队成员可以创建和参与项目任务                       │
│                                                     │
│                              [取消] [创建项目]      │
└─────────────────────────────────────────────────────┘
```

**2. 成员任务树（项目团队信息）**
```
┌─────────────────────────────────────────────────────┐
│ 工作区                                              │
│ 创始人测试工作区                                     │
│                                                     │
│ 项目                                                │
│ 核心功能模块生产就绪交付项目                         │
├─────────────────────────────────────────────────────┤
│ 👥 项目团队                                         │
│                                                     │
│ 👑 负责人                                           │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 🟡 田志博                                        │ │
│ │    founder@test.com                             │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 👤 成员 (4)                                         │
│ ┌───────────────────────────────────────┬─────────┐ │
│ │ 刘芳                                  │ senior  │ │
│ │ 王明                                  │全栈工程师│ │
│ │ 张伟                                  │后端开发  │ │
│ │ 李华                                  │ member  │ │
│ └───────────────────────────────────────┴─────────┘ │
└─────────────────────────────────────────────────────┘
```

**3. 成员任务分布树**
```
┌─────────────────────────────────────────────────────┐
│ 成员任务分布                                        │
│                                                     │
│ ▼ 核心功能模块生产就绪交付项目 团队                  │
│    │                                                │
│    ├─ 🟡 田志博  [负责人]     ████████ 12任务       │
│    ├─ 🔵 刘芳    [高级]       ████░░░░  8任务       │
│    ├─ 🟢 王明    [全栈工程师]  ██████░░ 10任务       │
│    ├─ 🟣 张伟    [后端开发]    ████░░░░  6任务       │
│    └─ 🔴 李华    [团队成员]    ██░░░░░░  4任务       │
└─────────────────────────────────────────────────────┘
```

---

### 2024-12-14 更新

#### 🎯 新增功能

##### 1. 批量任务处理
| 功能 | 描述 |
|------|------|
| **批量选择** | 在任务列表中可勾选多个任务 |
| **全选/取消全选** | 表头提供全选复选框 |
| **批量完成** | 一键将选中的任务标记为已完成 |
| **批量操作工具栏** | 显示已选任务数量，提供批量操作按钮 |

##### 2. AI 下一步建议（集成到新建任务）
| 功能 | 描述 |
|------|------|
| **智能任务生成** | AI 分析项目现有任务，建议下一步应该做什么 |
| **一键填充** | 点击建议的任务可自动填充到新建任务表单 |
| **上下文感知** | 基于已有任务的标题、状态、优先级进行分析 |

##### 3. AI 项目优化
| 功能 | 描述 |
|------|------|
| **优化项目标题** | AI 建议更专业、更具体的项目标题 |
| **优化项目描述** | 生成包含背景、目标、成果、里程碑的完整描述 |
| **建议项目负责人** | 推荐适合的负责人角色、技能及理由 |
| **建议团队构成** | 推荐团队角色、人数、技能和职责分工 |
| **其他优化建议** | 提供项目管理方面的改进建议 |

##### 4. AI 任务优化（单个任务）
| 功能 | 描述 |
|------|------|
| **优化任务标题** | AI 建议更清晰、更具体的任务标题 |
| **优化任务描述** | 生成详细的任务描述，包含步骤和要点 |
| **优化建议** | 提供任务执行方面的建议 |
| **一键应用** | 可直接将优化后的标题和描述应用到任务 |

#### 🔧 功能优化

| 优化项 | 描述 |
|--------|------|
| **项目优化按钮位置** | 从工具栏移至项目名称旁边，操作更便捷 |
| **AI 响应解析** | 改进 JSON 解析逻辑，支持 markdown 代码块 |
| **maxTokens 增加** | 从 1500 → 3000，避免 AI 响应被截断 |

#### 🐛 Bug 修复

| 问题 | 解决方案 |
|------|----------|
| AI 返回 `AI_PARSE_ERROR` 错误 | 增加 maxTokens，改进 parseJSON 函数 |
| AI 响应被截断导致 JSON 不完整 | maxTokens 从 1500 增加到 3000 |

---

#### 📁 更新文件清单

##### 后端 (backend/)

| 文件 | 更新内容 |
|------|----------|
| `src/services/aiService.ts` | • 新增 `optimizeProject()` - 项目优化<br>• 新增 `optimizeSingleTask()` - 单任务优化<br>• 新增 `generateNextTasks()` - 下一步任务建议<br>• 改进 `parseJSON()` 函数<br>• maxTokens 1500 → 3000 |
| `src/services/taskService.ts` | • 新增 `batchUpdateStatus()` - 批量更新任务状态 |
| `src/controllers/aiController.ts` | • 新增 `GET /ai/projects/:id/optimize-project`<br>• 新增 `GET /ai/tasks/:id/optimize`<br>• 新增 `POST /ai/projects/:id/generate-tasks` |
| `src/controllers/taskController.ts` | • 新增 `POST /tasks/batch/status` - 批量状态更新 |

##### 前端 (frontend/)

| 文件 | 更新内容 |
|------|----------|
| `src/pages/ProjectDetail.tsx` | • 新增项目优化弹窗<br>• 新增批量操作模式<br>• 新增 AI 任务建议集成到新建任务弹窗<br>• 调整项目优化按钮位置 |
| `src/pages/ProjectDetail.css` | • 新增批量操作工具栏样式<br>• 新增项目优化弹窗样式<br>• 新增 AI 建议面板样式 |
| `src/pages/TaskDetail.tsx` | • 新增单任务 AI 优化功能<br>• 新增任务优化弹窗 |
| `src/pages/TaskDetail.css` | • 新增任务优化弹窗样式 |
| `src/components/TaskList.tsx` | • 新增任务选择功能（复选框）<br>• 新增全选功能 |
| `src/components/TaskList.css` | • 新增选择模式样式 |
| `src/services/ai.ts` | • 新增 `ProjectOptimizationResult` 接口<br>• 新增 `SingleTaskOptimization` 接口<br>• 新增 `optimizeProject()` 方法<br>• 新增 `optimizeSingleTask()` 方法<br>• 新增 `generateNextTasks()` 方法 |
| `src/services/task.ts` | • 新增 `batchUpdateTaskStatus()` 方法 |

---

#### 🖼️ 功能截图说明

**1. 批量任务处理**
```
┌─────────────────────────────────────────────────────┐
│ [批量操作模式]                                       │
│ ┌─┐ ☑ 已选择 5 个任务    [✓ 批量完成] [取消选择]     │
│ ├─┼──────────────────────────────────────────────── │
│ │☑│ 任务1 - 已完成                                  │
│ │☑│ 任务2 - 进行中                                  │
│ │☐│ 任务3 - 待办                                    │
│ │☑│ 任务4 - 待办                                    │
└─────────────────────────────────────────────────────┘
```

**2. AI 下一步建议（新建任务弹窗）**
```
┌─────────────────────────────────────────────────────┐
│ 新建任务                                         ✕  │
├─────────────────────────────────────────────────────┤
│ 🤖 AI 建议的下一步任务              [获取建议]      │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 📌 编写单元测试                                 │ │
│ │    优先级: 高 | 预计: 4小时                     │ │
│ │    [点击填充到表单]                             │ │
│ └─────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│ 任务标题: [________________________]                │
│ 任务描述: [________________________]                │
│ 优先级:   [中 ▼]                                   │
│                              [取消] [创建任务]      │
└─────────────────────────────────────────────────────┘
```

**3. AI 项目优化**
```
┌─────────────────────────────────────────────────────┐
│ ✨ AI 项目优化                                   ✕  │
├─────────────────────────────────────────────────────┤
│ 📝 项目标题优化                                     │
│   原标题: 新功能开发                                │
│   优化后: 核心功能模块研发与发布项目                 │
├─────────────────────────────────────────────────────┤
│ 👤 建议项目负责人                                   │
│   角色: 技术负责人/高级技术主管                      │
│   技能: 系统架构设计、团队管理、风险管理             │
├─────────────────────────────────────────────────────┤
│ 👥 建议团队构成                                     │
│   • 架构师 ×1    • 后端工程师 ×3                   │
│   • 前端工程师 ×2  • 测试工程师 ×2                  │
├─────────────────────────────────────────────────────┤
│                    [取消] [✓ 应用标题和描述优化]    │
└─────────────────────────────────────────────────────┘
```

**4. AI 任务优化（任务详情页）**
```
┌─────────────────────────────────────────────────────┐
│ 🪄 AI 任务优化                                   ✕  │
├─────────────────────────────────────────────────────┤
│ 📝 标题优化                                         │
│   原标题: 写代码                                    │
│   优化后: 实现用户认证模块核心逻辑                   │
├─────────────────────────────────────────────────────┤
│ 📋 描述优化                                         │
│   优化后:                                           │
│   1. 实现 JWT 令牌生成和验证                        │
│   2. 创建用户登录/注册接口                          │
│   3. 添加密码加密处理                               │
├─────────────────────────────────────────────────────┤
│ 💡 优化建议                                         │
│   • 建议添加单元测试覆盖                            │
│   • 考虑添加刷新令牌机制                            │
├─────────────────────────────────────────────────────┤
│                    [取消] [✓ 应用优化]              │
└─────────────────────────────────────────────────────┘
```

---

## 许可证

MIT
