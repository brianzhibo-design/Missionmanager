// Prisma Schema 文件
// 定义数据模型结构，不包含业务逻辑

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 用户模型
// ==========================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String?  // 手机号注册时可以没有密码
  avatar    String?
  
  // 个人信息
  profession    String?   // 职业：designer, developer, pm, marketing, hr, finance, operation, other
  bio           String?   // 个人简介
  phone         String?   @unique // 手机号（唯一）
  company       String?   // 公司/组织（可选）
  location      String?   // 所在地（可选）
  profileCompleted Boolean @default(false) @map("profile_completed") // 是否完成个人信息填写
  
  // 密码重置
  resetToken       String?   @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")
  
  // 手机验证码
  phoneCode       String?   @map("phone_code")       // 验证码
  phoneCodeExpiry DateTime? @map("phone_code_expiry") // 验证码过期时间
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联关系
  workspaces         WorkspaceUser[]
  createdTasks       Task[]           @relation("TaskCreator")
  assignedTasks      Task[]           @relation("TaskAssignee")
  taskEvents         TaskEvent[]
  taskComments       TaskComment[]
  mentionedIn        CommentMention[] @relation("MentionedUser")
  projectMemberships ProjectMember[]  @relation("ProjectMemberUser")
  managedMembers     ProjectMember[]  @relation("ProjectMemberManager")
  leadingProjects    Project[]        @relation("ProjectLeader") // 负责的项目
  notifications      Notification[]
  coffeeLotteries    CoffeeLottery[]
  sentMessages       BroadcastMessage[] @relation("MessageSender")
  receivedMessages   BroadcastMessageRecipient[] @relation("MessageRecipient")

  @@map("users")
}

// ==========================================
// 工作区模型
// ==========================================
model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联关系
  members           WorkspaceUser[]
  projects          Project[]
  reports           Report[]
  coffeeLotteries   CoffeeLottery[]
  broadcastMessages BroadcastMessage[]

  @@map("workspaces")
}

// ==========================================
// 工作区用户关联模型（多对多）
// ==========================================
model WorkspaceUser {
  id          String   @id @default(cuid())
  role        String   @default("member") // owner, admin, member
  joinedAt    DateTime @default(now()) @map("joined_at")

  // 外键
  userId      String   @map("user_id")
  workspaceId String   @map("workspace_id")

  // 关联关系
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@map("workspace_users")
}

// ==========================================
// 项目模型
// ==========================================
model Project {
  id          String    @id @default(cuid())
  name        String
  description String?
  status      String    @default("active") // active, archived, completed
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // 外键
  workspaceId String    @map("workspace_id")
  leaderId    String?   @map("leader_id") // 项目负责人

  // 关联关系
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  leader        User?           @relation("ProjectLeader", fields: [leaderId], references: [id], onDelete: SetNull)
  tasks         Task[]
  members       ProjectMember[]
  notifications Notification[]

  @@map("projects")
}

// ==========================================
// 项目成员模型（项目级别的角色和汇报关系）
// ==========================================
model ProjectMember {
  id        String   @id @default(cuid())
  role      String   @default("member") // project_admin, team_lead, member
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 外键
  projectId String  @map("project_id")
  userId    String  @map("user_id")
  managerId String? @map("manager_id") // 直属上级的 userId

  // 关联关系
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation("ProjectMemberUser", fields: [userId], references: [id], onDelete: Cascade)
  manager User?   @relation("ProjectMemberManager", fields: [managerId], references: [id], onDelete: SetNull)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([managerId])
  @@map("project_members")
}

// ==========================================
// 任务模型
// ==========================================
model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  status      String    @default("todo") // todo, in_progress, review, done
  priority    String    @default("medium") // low, medium, high, critical
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // 外键
  projectId   String  @map("project_id")
  creatorId   String  @map("creator_id")
  assigneeId  String? @map("assignee_id")
  parentId    String? @map("parent_id") // 支持子任务

  // 关联关系
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator       User             @relation("TaskCreator", fields: [creatorId], references: [id])
  assignee      User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  parent        Task?            @relation("SubTasks", fields: [parentId], references: [id])
  subTasks      Task[]           @relation("SubTasks")
  events        TaskEvent[]
  comments      TaskComment[]
  aiAnalyses    TaskAiAnalysis[]
  notifications Notification[]

  @@map("tasks")
}

// ==========================================
// 任务事件模型（记录任务变更历史）
// ==========================================
model TaskEvent {
  id        String   @id @default(cuid())
  type      String   // created, status_changed, assigned, commented, etc.
  data      Json     // 事件相关数据
  createdAt DateTime @default(now()) @map("created_at")

  // 外键
  taskId String @map("task_id")
  userId String @map("user_id")

  // 关联关系
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt])
  @@map("task_events")
}

// ==========================================
// 任务评论模型
// ==========================================
model TaskComment {
  id        String   @id @default(cuid())
  content   String   // 评论内容
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 外键
  taskId String @map("task_id")
  userId String @map("user_id")

  // 关联关系
  task     Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentions CommentMention[]

  @@index([taskId, createdAt])
  @@map("task_comments")
}

// ==========================================
// 评论@提及模型
// ==========================================
model CommentMention {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // 外键
  commentId       String @map("comment_id")
  mentionedUserId String @map("mentioned_user_id")

  // 关联关系
  comment       TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedUser User        @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)

  @@unique([commentId, mentionedUserId])
  @@map("comment_mentions")
}

// ==========================================
// 咖啡抽奖记录模型
// ==========================================
model CoffeeLottery {
  id          String   @id @default(cuid())
  date        DateTime @db.Date // 抽奖日期
  createdAt   DateTime @default(now()) @map("created_at")

  // 外键
  workspaceId String @map("workspace_id")
  winnerId    String @map("winner_id")

  // 关联关系
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  winner    User      @relation(fields: [winnerId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, date]) // 每个工作区每天只能有一个获奖者
  @@map("coffee_lotteries")
}

// ==========================================
// 群发消息模型
// ==========================================
model BroadcastMessage {
  id        String   @id @default(cuid())
  title     String
  content   String
  sendEmail Boolean  @default(false) @map("send_email") // 是否发送邮件
  createdAt DateTime @default(now()) @map("created_at")

  // 外键
  workspaceId String @map("workspace_id")
  senderId    String @map("sender_id")

  // 关联关系
  workspace  Workspace                  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sender     User                       @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipients BroadcastMessageRecipient[]

  @@index([workspaceId, createdAt])
  @@map("broadcast_messages")
}

// ==========================================
// 群发消息接收者模型
// ==========================================
model BroadcastMessageRecipient {
  id        String    @id @default(cuid())
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // 外键
  messageId   String @map("message_id")
  recipientId String @map("recipient_id")

  // 关联关系
  message   BroadcastMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  recipient User             @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([messageId, recipientId])
  @@map("broadcast_message_recipients")
}

// ==========================================
// 任务 AI 分析结果模型
// ==========================================
model TaskAiAnalysis {
  id           String   @id @default(cuid())
  analysisType String   @map("analysis_type") // task_level, project_level, event_stream
  result       Json     // 分析结果（遵循 JSON Schema）
  modelVersion String   @map("model_version")
  createdAt    DateTime @default(now()) @map("created_at")

  // 外键
  taskId String @map("task_id")

  // 关联关系
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@map("task_ai_analyses")
}

// ==========================================
// 通知模型
// ==========================================
model Notification {
  id        String    @id @default(cuid())
  type      String    // task_assigned, task_status_changed, task_due_soon, task_overdue, mention, report_ready
  title     String
  message   String
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // 外键
  userId    String  @map("user_id")
  taskId    String? @map("task_id")
  projectId String? @map("project_id")

  // 关联关系
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ==========================================
// 报告模型
// ==========================================
model Report {
  id          String   @id @default(cuid())
  type        String   // weekly, monthly
  title       String
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  content     Json     // 报告内容（统计数据）
  summary     String?  // AI 生成的摘要
  highlights  Json?    // 亮点
  concerns    Json?    // 关注点
  generatedBy String?  @map("generated_by") // 生成者 userId
  createdAt   DateTime @default(now()) @map("created_at")

  // 外键
  workspaceId String @map("workspace_id")

  // 关联关系
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, type])
  @@index([workspaceId, startDate])
  @@map("reports")
}

