generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                      @id @default(cuid())
  email              String                      @unique
  name               String
  password           String?
  avatar             String?
  createdAt          DateTime                    @default(now()) @map("created_at")
  updatedAt          DateTime                    @updatedAt @map("updated_at")
  bio                String?
  company            String?
  location           String?
  phone              String?                     @unique
  profession         String?
  profileCompleted   Boolean                     @default(false) @map("profile_completed")
  resetToken         String?                     @map("reset_token")
  resetTokenExpiry   DateTime?                   @map("reset_token_expiry")
  phoneCode          String?                     @map("phone_code")
  phoneCodeExpiry    DateTime?                   @map("phone_code_expiry")
  receivedMessages   BroadcastMessageRecipient[] @relation("MessageRecipient")
  sentMessages       BroadcastMessage[]          @relation("MessageSender")
  coffeeLotteries    CoffeeLottery[]
  mentionedIn        CommentMention[]            @relation("MentionedUser")
  notifications      Notification[]
  managedMembers     ProjectMember[]             @relation("ProjectMemberManager")
  projectMemberships ProjectMember[]             @relation("ProjectMemberUser")
  leadingProjects    Project[]                   @relation("ProjectLeader")
  taskComments       TaskComment[]
  commentLikes       CommentLike[]
  taskEvents         TaskEvent[]
  assignedTasks      Task[]                      @relation("TaskAssignee")
  createdTasks       Task[]                      @relation("TaskCreator")
  workspaces         WorkspaceUser[]
  workReports        WorkReport[]

  @@map("users")
}

model Workspace {
  id                String             @id @default(cuid())
  name              String
  description       String?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  broadcastMessages BroadcastMessage[]
  coffeeLotteries   CoffeeLottery[]
  projects          Project[]
  reports           Report[]
  members           WorkspaceUser[]

  @@map("workspaces")
}

model WorkspaceUser {
  id          String    @id @default(cuid())
  role        String    @default("member")
  joinedAt    DateTime  @default(now()) @map("joined_at")
  userId      String    @map("user_id")
  workspaceId String    @map("workspace_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@map("workspace_users")
}

model Project {
  id            String          @id @default(cuid())
  name          String
  description   String?
  status        String          @default("active")
  startDate     DateTime?       @map("start_date")
  endDate       DateTime?       @map("end_date")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  workspaceId   String          @map("workspace_id")
  leaderId      String?         @map("leader_id")
  notifications Notification[]
  members       ProjectMember[]
  leader        User?           @relation("ProjectLeader", fields: [leaderId], references: [id])
  workspace     Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks         Task[]

  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  role      String   @default("member")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  managerId String?  @map("manager_id")
  manager   User?    @relation("ProjectMemberManager", fields: [managerId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation("ProjectMemberUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([managerId])
  @@map("project_members")
}

model Task {
  id            String           @id @default(cuid())
  title         String
  description   String?
  status        String           @default("todo")
  priority      String           @default("medium")
  dueDate       DateTime?        @map("due_date")
  completedAt   DateTime?        @map("completed_at")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")
  projectId     String           @map("project_id")
  creatorId     String           @map("creator_id")
  assigneeId    String?          @map("assignee_id")
  parentId      String?          @map("parent_id")
  notifications Notification[]
  aiAnalyses    TaskAiAnalysis[]
  comments      TaskComment[]
  events        TaskEvent[]
  assignee      User?            @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator       User             @relation("TaskCreator", fields: [creatorId], references: [id])
  parent        Task?            @relation("SubTasks", fields: [parentId], references: [id])
  subTasks      Task[]           @relation("SubTasks")
  project       Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model TaskEvent {
  id        String   @id @default(cuid())
  type      String
  data      Json
  createdAt DateTime @default(now()) @map("created_at")
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt])
  @@map("task_events")
}

model TaskComment {
  id        String           @id @default(cuid())
  content   String
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")
  taskId    String           @map("task_id")
  userId    String           @map("user_id")
  mentions  CommentMention[]
  likes     CommentLike[]
  task      Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@map("task_comments")
}

model CommentLike {
  id        String      @id @default(cuid())
  createdAt DateTime    @default(now()) @map("created_at")
  commentId String      @map("comment_id")
  userId    String      @map("user_id")
  comment   TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@map("comment_likes")
}

model CommentMention {
  id              String      @id @default(cuid())
  createdAt       DateTime    @default(now()) @map("created_at")
  commentId       String      @map("comment_id")
  mentionedUserId String      @map("mentioned_user_id")
  comment         TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedUser   User        @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)

  @@unique([commentId, mentionedUserId])
  @@map("comment_mentions")
}

model CoffeeLottery {
  id          String    @id @default(cuid())
  date        DateTime  @db.Date
  createdAt   DateTime  @default(now()) @map("created_at")
  workspaceId String    @map("workspace_id")
  winnerId    String    @map("winner_id")
  winner      User      @relation(fields: [winnerId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, date])
  @@map("coffee_lotteries")
}

model BroadcastMessage {
  id          String                      @id @default(cuid())
  title       String
  content     String
  sendEmail   Boolean                     @default(false) @map("send_email")
  createdAt   DateTime                    @default(now()) @map("created_at")
  workspaceId String                      @map("workspace_id")
  senderId    String                      @map("sender_id")
  recipients  BroadcastMessageRecipient[]
  sender      User                        @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  workspace   Workspace                   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
  @@map("broadcast_messages")
}

model BroadcastMessageRecipient {
  id          String           @id @default(cuid())
  isRead      Boolean          @default(false) @map("is_read")
  readAt      DateTime?        @map("read_at")
  createdAt   DateTime         @default(now()) @map("created_at")
  messageId   String           @map("message_id")
  recipientId String           @map("recipient_id")
  message     BroadcastMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  recipient   User             @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([messageId, recipientId])
  @@map("broadcast_message_recipients")
}

model TaskAiAnalysis {
  id           String   @id @default(cuid())
  analysisType String   @map("analysis_type")
  result       Json
  modelVersion String   @map("model_version")
  createdAt    DateTime @default(now()) @map("created_at")
  taskId       String   @map("task_id")
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@map("task_ai_analyses")
}

model Notification {
  id        String    @id @default(cuid())
  type      String
  title     String
  message   String
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")
  userId    String    @map("user_id")
  taskId    String?   @map("task_id")
  projectId String?   @map("project_id")
  project   Project?  @relation(fields: [projectId], references: [id])
  task      Task?     @relation(fields: [taskId], references: [id])
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model Report {
  id          String    @id @default(cuid())
  type        String
  title       String
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  content     Json
  summary     String?
  highlights  Json?
  concerns    Json?
  generatedBy String?   @map("generated_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  workspaceId String    @map("workspace_id")
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, type])
  @@index([workspaceId, startDate])
  @@map("reports")
}

// 工作日报/周报/月报
model WorkReport {
  id              String   @id @default(cuid())
  type            String   // daily, weekly, monthly
  reportDate      DateTime @map("report_date") @db.Date // 日报日期/周报开始日期/月报月份
  
  // 工作内容
  todayWork       String?  @map("today_work") // 今日/本周/本月完成的工作
  tomorrowPlan    String?  @map("tomorrow_plan") // 明日/下周/下月计划
  issues          String?  // 遇到的问题和困难
  needSupport     String?  @map("need_support") // 需要的支持和协助
  summary         String?  // 工作总结
  
  // 关联的任务数据（自动统计）
  completedTaskIds Json?   @map("completed_task_ids") // 已完成任务ID列表
  inProgressTaskIds Json?  @map("in_progress_task_ids") // 进行中任务ID列表
  
  // 统计数据
  completedCount  Int      @default(0) @map("completed_count") // 完成任务数
  inProgressCount Int      @default(0) @map("in_progress_count") // 进行中任务数
  totalHours      Float?   @map("total_hours") // 工作时长（可选）
  
  // 心情和状态（可选）
  mood            String?  // happy, normal, tired, stressed
  workload        String?  // light, normal, heavy, overload
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  // 关联
  userId          String   @map("user_id")
  workspaceId     String   @map("workspace_id")
  projectId       String?  @map("project_id") // 可选：针对特定项目的日报
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, workspaceId, type, reportDate]) // 每人每天/周/月只能提交一份
  @@index([workspaceId, type, reportDate])
  @@index([userId, reportDate])
  @@index([projectId, reportDate])
  @@map("work_reports")
}
