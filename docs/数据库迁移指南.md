# æ•°æ®åº“è¿ç§»æŒ‡å—ï¼šProjectMember.role â†’ isLeader

## ğŸ“‹ è¿ç§»æ¦‚è¿°

æœ¬æ¬¡è¿ç§»å°† `project_members` è¡¨çš„ `role` å­—æ®µæ”¹ä¸º `is_leader` å¸ƒå°”å­—æ®µï¼Œç®€åŒ–é¡¹ç›®æˆå‘˜è§’è‰²ä½“ç³»ã€‚

**è¿ç§»æ–‡ä»¶ï¼š** `backend/prisma/migrations/20251219205541_replace_project_member_role_with_is_leader/migration.sql`

**è¿ç§»çŠ¶æ€ï¼š** âœ… å·²åˆ›å»ºå¹¶æäº¤åˆ° Git

---

## ğŸš€ è¿ç§»æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Prisma Migrateï¼ˆæ¨èï¼‰

#### å¼€å‘ç¯å¢ƒ
```bash
cd backend
npx prisma migrate dev
```

#### ç”Ÿäº§ç¯å¢ƒ
```bash
cd backend
npx prisma migrate deploy
```

---

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨æ‰§è¡Œ SQLï¼ˆå¦‚æœ Prisma Migrate å¤±è´¥ï¼‰

#### 1. å¤‡ä»½æ•°æ®åº“ï¼ˆé‡è¦ï¼ï¼‰
```bash
pg_dump -h localhost -U your_user -d taskdb > backup_$(date +%Y%m%d_%H%M%S).sql
```

#### 2. æ‰§è¡Œè¿ç§» SQL

è¿æ¥åˆ° PostgreSQL æ•°æ®åº“ï¼Œæ‰§è¡Œä»¥ä¸‹ SQLï¼š

```sql
-- Step 1: æ·»åŠ æ–°çš„ isLeader å­—æ®µ
ALTER TABLE "project_members" ADD COLUMN "is_leader" BOOLEAN NOT NULL DEFAULT false;

-- Step 2: è¿ç§»ç°æœ‰æ•°æ®ï¼šå°† role = 'lead' æˆ– 'project_admin' çš„é¡¹ç›®æˆå‘˜è®¾ç½®ä¸º isLeader = true
UPDATE "project_members" 
SET "is_leader" = true 
WHERE "role" IN ('lead', 'project_admin');

-- Step 3: åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS "project_members_is_leader_idx" ON "project_members"("is_leader");

-- Step 4: åˆ é™¤æ—§çš„ role å­—æ®µ
ALTER TABLE "project_members" DROP COLUMN "role";
```

#### 3. éªŒè¯è¿ç§»ç»“æœ

```sql
-- æ£€æŸ¥è¡¨ç»“æ„
\d project_members

-- æ£€æŸ¥æ•°æ®è¿ç§»æ˜¯å¦æ­£ç¡®
SELECT 
  COUNT(*) as total_members,
  COUNT(*) FILTER (WHERE is_leader = true) as leaders,
  COUNT(*) FILTER (WHERE is_leader = false) as members
FROM project_members;
```

---

## âœ… è¿ç§»éªŒè¯æ¸…å•

- [ ] æ•°æ®åº“å¤‡ä»½å·²å®Œæˆ
- [ ] `is_leader` å­—æ®µå·²æ·»åŠ 
- [ ] ç°æœ‰æ•°æ®å·²æ­£ç¡®è¿ç§»ï¼ˆ`role = 'lead'` æˆ– `'project_admin'` â†’ `is_leader = true`ï¼‰
- [ ] ç´¢å¼•å·²åˆ›å»º
- [ ] `role` å­—æ®µå·²åˆ é™¤
- [ ] åº”ç”¨å¯åŠ¨æ­£å¸¸
- [ ] é¡¹ç›®æˆå‘˜ç®¡ç†åŠŸèƒ½æ­£å¸¸

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœè¿ç§»å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

```sql
-- 1. æ¢å¤ role å­—æ®µ
ALTER TABLE "project_members" ADD COLUMN "role" VARCHAR(50) DEFAULT 'member';

-- 2. ä» is_leader æ¢å¤æ•°æ®
UPDATE "project_members" 
SET "role" = CASE 
  WHEN "is_leader" = true THEN 'project_admin'
  ELSE 'member'
END;

-- 3. åˆ é™¤ is_leader å­—æ®µ
ALTER TABLE "project_members" DROP COLUMN "is_leader";
DROP INDEX IF EXISTS "project_members_is_leader_idx";
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒè¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“**
2. **å»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œè¿ç§»**
3. **è¿ç§»æœŸé—´åº”ç”¨å¯èƒ½éœ€è¦çŸ­æš‚åœæœº**
4. **è¿ç§»åéªŒè¯æ‰€æœ‰ç›¸å…³åŠŸèƒ½æ˜¯å¦æ­£å¸¸**

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: è¿ç§»å¤±è´¥ï¼Œæç¤ºå­—æ®µå·²å­˜åœ¨
A: æ£€æŸ¥æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡éƒ¨åˆ†è¿ç§»ï¼Œå¯ä»¥æ‰‹åŠ¨è·³è¿‡å·²å®Œæˆçš„æ­¥éª¤ã€‚

### Q: æ•°æ®è¿ç§»ä¸å®Œæ•´
A: æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»– role å€¼éœ€è¦æ˜ å°„ï¼Œå¯ä»¥æ‰‹åŠ¨è°ƒæ•´ UPDATE è¯­å¥ã€‚

### Q: Prisma ç±»å‹é”™è¯¯
A: è¿è¡Œ `npx prisma generate` é‡æ–°ç”Ÿæˆ Prisma Clientã€‚

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- Prisma è¿ç§»æ–‡æ¡£ï¼šhttps://www.prisma.io/docs/concepts/components/prisma-migrate
- é¡¹ç›® Issueï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç›¸å…³å·²çŸ¥é—®é¢˜

