# 成员任务树权限说明

## 功能概述

成员任务树用于展示项目团队成员及其任务分布，支持层级关系展示、成员信息编辑和AI团队分析。

---

## 权限总览

### 1. 查看成员任务树

**接口**: `GET /tree/projects/:projectId/members`  
**服务方法**: `treeService.getMemberTree()`

| 角色 | 权限 | 说明 |
|------|:----:|------|
| 🏯 掌门 (owner) | ✅ | 可查看所有项目的成员任务树 |
| 🧙 长老 (director) | ✅ | 可查看所有项目的成员任务树 |
| 🗡️ 堂主 (manager) | ✅ | 可查看所有项目的成员任务树 |
| 🥋 弟子 (member) | ✅ | 可查看自己参与项目的成员任务树 |
| 🍵 俗客 (observer) | ✅ | 可查看自己参与项目的成员任务树 |

**权限检查逻辑**:
```typescript
// 只要用户是工作区成员即可查看
const workspaceMembership = await workspaceRepository.getMembership(
  project.workspaceId, 
  userId
);
if (!workspaceMembership) {
  throw new AppError('无权访问此项目', 403, 'ACCESS_DENIED');
}
```

**数据范围**:
- 显示项目负责人和所有项目团队成员
- 显示每个成员被分配的任务（只统计主任务，排除子任务）
- 显示任务统计信息（总数、待办、进行中、审核中、阻塞、已完成）

---

### 2. 编辑成员角色

**接口**: `PUT /admin/projects/:projectId/members/:userId/role`  
**服务方法**: `adminService.setProjectMemberRole()`

| 角色 | 权限 | 说明 |
|------|:----:|------|
| 🏯 掌门 (owner) | ✅ | 可编辑所有项目成员的角色 |
| 🧙 长老 (director) | ✅ | 可编辑所有项目成员的角色 |
| 🗡️ 堂主 (manager) | ✅ | 可编辑所有项目成员的角色 |
| 🥋 弟子 (member) | ❌ | 不能编辑成员角色 |
| 🍵 俗客 (observer) | ❌ | 不能编辑成员角色 |

**权限检查逻辑**:
```typescript
// 需要项目管理员权限
await this.requireProjectAdmin(projectId, operatorId);

// requireProjectAdmin 检查：
// 1. 工作区角色：owner、director、manager 有所有项目的权限
// 2. 项目角色：project_admin、team_lead 有项目级别权限
```

**可设置的角色**:
- **预设角色**:
  - `project_admin`: 项目管理员
  - `team_lead`: 团队负责人
  - `senior`: 高级成员
  - `member`: 普通成员
  - `observer`: 观察者
- **自定义角色**: 1-30个字符，默认为 member 级别权限

**限制规则**:
- 如果设置了上级（managerId），上级的角色优先级必须高于下属
- 不能将自己设为自己的上级
- 不能形成循环汇报关系

---

### 3. AI 团队分析

**接口**: `POST /tree/analysis/team/:projectId`  
**服务方法**: `treeAnalysisService.analyzeTeamTree()`

| 角色 | 权限 | 说明 |
|------|:----:|------|
| 🏯 掌门 (owner) | ✅ | 可使用AI分析所有项目团队 |
| 🧙 长老 (director) | ✅ | 可使用AI分析所有项目团队 |
| 🗡️ 堂主 (manager) | ✅ | 可使用AI分析所有项目团队 |
| 🥋 弟子 (member) | ❌ | 不能使用AI团队分析 |
| 🍵 俗客 (observer) | ❌ | 不能使用AI团队分析 |

**权限检查逻辑**:
```typescript
// 通过 getMemberTree 间接检查权限
// 但实际应该只有项目管理员才能使用
// 当前实现：所有能查看成员任务树的用户都可以使用
// 建议：应该添加额外的权限检查
```

**分析内容**:
- 团队健康状况评分
- 工作负载分析（过载成员、空闲成员、负载均衡度）
- 瓶颈识别（阻塞任务、依赖问题、资源问题）
- 改进建议（行动项、影响、工作量）
- 洞察总结

---

### 4. 查看成员详情

**功能**: 点击成员节点查看详细信息

| 角色 | 权限 | 说明 |
|------|:----:|------|
| 🏯 掌门 (owner) | ✅ | 可查看所有成员详情 |
| 🧙 长老 (director) | ✅ | 可查看所有成员详情 |
| 🗡️ 堂主 (manager) | ✅ | 可查看所有成员详情 |
| 🥋 弟子 (member) | ✅ | 可查看所有成员详情 |
| 🍵 俗客 (observer) | ✅ | 可查看所有成员详情 |

**显示信息**:
- 成员基本信息（姓名、邮箱、头像）
- 项目角色
- 任务统计（总数、待办、进行中、审核中、阻塞、已完成）
- 任务列表（标题、状态、优先级、截止日期）

---

## 权限矩阵

| 功能 | 🏯掌门 | 🧙长老 | 🗡️堂主 | 🥋弟子 | 🍵俗客 |
|------|:-----:|:-----:|:-----:|:-----:|:-----:|
| **查看** |
| 查看成员任务树 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 查看成员详情 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **编辑** |
| 编辑成员角色 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 设置汇报关系 | ✅ | ✅ | ✅ | ❌ | ❌ |
| **分析** |
| AI团队分析 | ✅ | ✅ | ✅ | ❌ | ❌ |

---

## 权限检查流程

### 查看成员任务树

```
用户请求 → 检查是否为工作区成员 → 获取项目信息 → 构建成员树 → 返回数据
```

### 编辑成员角色

```
用户请求 → 检查项目管理员权限 → 验证角色值 → 验证汇报关系 → 更新数据库 → 返回结果
```

### AI团队分析

```
用户请求 → 检查查看权限（通过getMemberTree） → 获取成员树数据 → 调用AI分析 → 返回分析结果
```

---

## 数据权限范围

### 成员数据
- **显示范围**: 项目负责人 + 项目团队成员
- **如果项目无成员**: 显示工作区所有成员（作为备选）

### 任务数据
- **统计范围**: 只统计主任务（`parentId === null`），排除子任务
- **任务归属**: 只显示分配给该成员的任务（`assigneeId === member.userId`）

### 角色显示
- **负责人**: 显示为"负责人"
- **project_admin**: 显示为"项目管理员"
- **team_lead**: 显示为"团队负责人"
- **member**: 显示为"团队成员"
- **其他**: 显示自定义角色名称

---

## 权限边界说明

### 1. 查看权限
- ✅ **所有工作区成员**都可以查看成员任务树
- ✅ 包括 observer（俗客）也可以查看
- ⚠️ **注意**: 实际业务中，observer 可能不应该看到详细的任务信息

### 2. 编辑权限
- ✅ **项目管理员**可以编辑成员角色
- ✅ 包括工作区的 owner、director、manager（对所有项目）
- ✅ 包括项目的 project_admin、team_lead（项目级别）
- ❌ **member 和 observer** 不能编辑

### 3. AI分析权限
- ⚠️ **当前实现**: 所有能查看成员任务树的用户都可以使用
- 💡 **建议**: 应该限制为项目管理员才能使用AI团队分析
- ✅ **符合设计**: owner、director、manager 可以使用

---

## 特殊场景处理

### 场景1: 项目无成员
- 如果项目没有团队成员，会显示工作区所有成员作为备选
- 这些成员的任务统计为0（因为不是项目成员）

### 场景2: 成员无任务
- 成员节点仍然显示，但任务统计为0
- 任务列表为空

### 场景3: 循环汇报关系
- 系统会检测并阻止循环汇报关系的设置
- 通过 `visited` Set 防止无限递归

### 场景4: 自定义角色
- 支持自定义角色名称（1-30个字符）
- 自定义角色默认权限级别为 member（优先级 4）
- 可以设置汇报关系

---

## 权限改进建议

### 1. AI团队分析权限
**当前问题**: 所有能查看成员任务树的用户都可以使用AI分析  
**建议**: 限制为项目管理员才能使用

```typescript
// 建议修改 treeAnalysisService.analyzeTeamTree()
async analyzeTeamTree(userId: string, projectId: string) {
  // 添加项目管理员权限检查
  await adminService.requireProjectAdmin(projectId, userId);
  
  // 其余逻辑不变
  const treeData = await treeService.getMemberTree(userId, projectId);
  // ...
}
```

### 2. Observer 查看权限
**当前问题**: observer 可以看到详细的任务信息  
**建议**: observer 只能看到成员列表，不能看到任务详情

```typescript
// 建议修改 treeService.getMemberTree()
// 根据用户角色决定是否显示任务详情
if (workspaceMembership.role === 'observer') {
  // 只返回成员列表，不返回任务详情
  tasks = [];
}
```

### 3. 成员编辑按钮显示
**当前实现**: 所有用户都能看到编辑按钮  
**建议**: 只有有编辑权限的用户才显示编辑按钮

```typescript
// 前端检查权限
const canEdit = hasProjectPermission(projectRole, 'manage') || 
                hasWorkspacePermission(workspaceRole, 'manageMembers');
```

---

## 相关代码文件

### 后端
- `backend/src/services/treeService.ts` - 成员任务树服务
- `backend/src/services/adminService.ts` - 成员角色管理服务
- `backend/src/services/treeAnalysisService.ts` - AI团队分析服务
- `backend/src/controllers/treeController.ts` - 树视图控制器
- `backend/src/controllers/adminController.ts` - 管理控制器

### 前端
- `frontend/src/pages/admin/MembersTree.tsx` - 成员任务树页面
- `frontend/src/components/tree/MemberEditModal.tsx` - 成员编辑弹窗
- `frontend/src/components/tree/MemberDetailPanel.tsx` - 成员详情面板
- `frontend/src/services/tree.ts` - 树视图服务

---

*最后更新：2025年1月*

