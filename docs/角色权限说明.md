# 真实世界组织架构权限设计

## 参考模型

```
CEO/创始人 → VP/总监 → 经理/主管 → 员工 → 实习生/外部顾问
```

---

## 角色定位与权限

### 🏯 掌门 (owner) - 创始人/CEO

> *真实定位：公司所有者，拥有最终决策权，但不一定参与日常管理*

| 权限类别 | 权限项 | 状态 | 说明 |
|---------|--------|:----:|------|
| **组织管理** | 工作区设置 | ✅ | 公司章程只有老板能改 |
| | 解散工作区 | ✅ | 关闭公司的权力 |
| **人事权** | 邀请成员 | ✅ | 可以招任何人 |
| | 设置任何角色 | ✅ | 可以任命VP/总监 |
| | 移除任何人 | ✅ | 最终解雇权 |
| **项目权** | 创建/编辑/删除项目 | ✅ | 完全控制 |
| **任务权** | 所有任务操作 | ✅ | 完全控制 |
| **数据权** | 全部数据访问 | ✅ | 看所有报表 |
| **AI功能** | 全部 | ✅ | |

---

### 🧙 长老 (director) - VP/总监

> *真实定位：管理多个团队，有招聘和部分解雇权，向CEO汇报*

| 权限类别 | 权限项 | 状态 | 说明 |
|---------|--------|:----:|------|
| **组织管理** | 工作区设置 | ❌ | 公司架构不能随便改 |
| **人事权** | 邀请成员 | ✅ | 可以招人 |
| | 设置角色（≤堂主） | ✅ | 可以任命经理，不能任命VP |
| | 移除成员（≤堂主） | ✅ | 可以解雇经理及以下 |
| **项目权** | 创建项目 | ✅ | 可以立项 |
| | 编辑所有项目 | ✅ | 可以调整任何项目 |
| | 删除项目 | ✅ | 可以砍项目 |
| **任务权** | 所有任务操作 | ✅ | 完全控制 |
| **数据权** | 管理员视图 | ✅ | 看全局数据 |
| | 所有报告 | ✅ | |
| | 所有日报 | ✅ | |
| **AI功能** | 全局分析 | ✅ | |
| | 项目分析 | ✅ | |

---

### 🗡️ 堂主 (manager) - 经理/主管

> *真实定位：管理一个团队，可以招人但需要上级批准角色，负责项目交付*

| 权限类别 | 权限项 | 状态 | 说明 |
|---------|--------|:----:|------|
| **组织管理** | 工作区设置 | ❌ | |
| **人事权** | 邀请成员 | ✅ | 可以招人进团队 |
| | 设置角色 | ❌ | 不能决定职级（HR/VP决定） |
| | 移除成员 | ❌ | 不能直接解雇（需要上级同意） |
| **项目权** | 创建项目 | ✅ | 可以发起新项目 |
| | 编辑项目（自己负责的） | ✅ | 只能改自己的项目 |
| | 删除项目 | ❌ | 砍项目需要VP同意 |
| **任务权** | 创建任务 | ✅ | |
| | 编辑所有任务 | ✅ | 可以调整团队任务 |
| | 删除任务 | ✅ | 可以取消任务 |
| | 分配任务 | ✅ | 核心职责：派活 |
| **数据权** | 管理员视图（只读） | ✅ | 了解团队情况 |
| | 团队报告 | ✅ | 看团队绩效 |
| | 下属日报 | ✅ | 看直接下属的 |
| **AI功能** | 全局分析 | ❌ | |
| | 项目分析 | ✅ | 分析自己的项目 |

---

### 🥋 弟子 (member) - 普通员工

> *真实定位：执行具体工作，对自己的任务负责，可以提建议*

| 权限类别 | 权限项 | 状态 | 说明 |
|---------|--------|:----:|------|
| **组织管理** | 全部 | ❌ | |
| **人事权** | 邀请成员 | ❌ | 招人是经理的事 |
| | 管理成员 | ❌ | |
| **项目权** | 创建项目 | ✅ | 可以提议新项目 |
| | 编辑项目 | ❌ | 项目设置由经理管 |
| | 删除项目 | ❌ | |
| **任务权** | 创建任务 | ✅ | 可以给自己创建任务 |
| | 编辑任务（自己相关的） | ✅ | 自己创建的或被分配的 |
| | 删除任务 | ❌ | 任务取消需要经理同意 |
| | 分配任务 | ❌ | 派活是经理的事 |
| **数据权** | 管理员视图 | ❌ | |
| | 个人报告 | ✅ | 只看自己的绩效 |
| | 团队日报 | ❌ | |
| **AI功能** | 任务分析 | ✅ | 可以用AI优化自己的任务 |
| | 全局/项目分析 | ❌ | |
| **其他** | 填写日报 | ✅ | |
| | 评论 | ✅ | |

---

### 🍵 俗客 (observer) - 实习生/外部顾问/客户

> *真实定位：临时参与者，主要是了解情况、学习或提供建议*

| 权限类别 | 权限项 | 状态 | 说明 |
|---------|--------|:----:|------|
| **查看权** | 查看项目 | ✅ | 了解项目情况 |
| | 查看任务 | ✅ | 了解进度 |
| | 查看成员 | ✅ | 知道团队构成 |
| **参与权** | 评论 | ✅ | 可以提建议、问问题 |
| | 填写日报 | ❌ | 不是正式员工 |
| **其他** | 所有编辑/删除/管理权限 | ❌ | |

---

## 权限对比总表

| 权限 | 🏯掌门 | 🧙长老 | 🗡️堂主 | 🥋弟子 | 🍵俗客 |
|------|:-----:|:-----:|:-----:|:-----:|:-----:|
| **组织层** |
| 工作区设置 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 解散工作区 | ✅ | ❌ | ❌ | ❌ | ❌ |
| **人事层** |
| 邀请成员 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 设置角色 | ✅全部 | ✅≤堂主 | ❌ | ❌ | ❌ |
| 移除成员 | ✅全部 | ✅≤堂主 | ❌ | ❌ | ❌ |
| **项目层** |
| 创建项目 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 编辑项目 | ✅全部 | ✅全部 | ✅自己的 | ❌ | ❌ |
| 删除项目 | ✅ | ✅ | ❌ | ❌ | ❌ |
| **任务层** |
| 创建任务 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 编辑任务 | ✅全部 | ✅全部 | ✅全部 | ✅自己的 | ❌ |
| 删除任务 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 分配任务 | ✅ | ✅ | ✅ | ❌ | ❌ |
| **数据层** |
| 管理员视图 | ✅ | ✅ | ✅只读 | ❌ | ❌ |
| 统计报告 | ✅全部 | ✅全部 | ✅团队 | ✅自己 | ❌ |
| 团队日报 | ✅全部 | ✅全部 | ✅下属 | ❌ | ❌ |
| **AI层** |
| 全局分析 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 项目分析 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 任务分析 | ✅ | ✅ | ✅ | ✅ | ❌ |
| **日常层** |
| 填写日报 | ✅ | ✅ | ✅ | ✅ | ❌ |
| 评论 | ✅ | ✅ | ✅ | ✅ | ✅ |

---

## 权限层级图

```
🏯 掌门 ─────────────────────────────────────────── 战略层
    │   • 公司所有权
    │   • 最终决策权
    │
🧙 长老 ─────────────────────────────────────────── 管理层
    │   • 管理多团队
    │   • 招聘/解雇权（≤堂主）
    │   • 全局数据访问
    │
🗡️ 堂主 ─────────────────────────────────────────── 执行管理层
    │   • 管理一个团队
    │   • 任务分配权
    │   • 团队数据访问
    │
🥋 弟子 ─────────────────────────────────────────── 执行层
    │   • 完成任务
    │   • 个人数据访问
    │
🍵 俗客 ─────────────────────────────────────────── 观察层
        • 查看和评论
```

---

## 关键改进点

| 改进 | 原来 | 现在 | 理由 |
|------|------|------|------|
| 堂主邀请成员 | ❌ | ✅ | 经理应该能招人进团队 |
| 堂主管理员视图 | ❌ | ✅只读 | 经理需要了解团队全貌 |
| 堂主AI项目分析 | ❌ | ✅ | 经理需要分析自己的项目 |
| 弟子编辑任务 | ✅全部 | ✅自己的 | 员工只能改自己负责的 |
| 弟子查看报告 | ❌ | ✅自己的 | 员工应该能看自己的绩效 |
| 弟子AI任务分析 | ❌ | ✅ | 员工可以用AI优化自己的工作 |
| 俗客评论 | ❌ | ✅ | 观察者至少能提建议 |
| 长老删除项目 | ❌ | ✅ | VP应该能砍项目 |

---

## 权限检查规则

### 1. 工作区权限检查
- 使用 `hasWorkspacePermission(role, permission)` 检查
- 角色必须明确在权限列表中才能执行操作

### 2. 项目权限检查
- 使用 `hasProjectPermission(role, permission)` 检查
- 项目管理员权限包括：工作区的 owner、director、manager，以及项目的 project_admin、team_lead

### 3. 任务权限检查
- **owner, director, manager**: 可以编辑所有任务
- **member**: 只能编辑自己创建或被分配的任务
- **observer**: 无编辑权限

### 4. 项目编辑权限检查
- **owner, director**: 可以编辑所有项目
- **manager**: 只能编辑自己负责的项目（leaderId === userId）
- **member, observer**: 无编辑权限

### 5. 角色修改规则
- **Owner** 可以修改所有成员的角色（但不能修改其他 owner）
- **Director** 可以修改 manager 及以下角色的成员
- **Manager** 不能设置角色（需要上级批准）
- 不能邀请或设置为比自己更高的角色
- 不能将自己设为自己的上级（汇报关系）

---

## 特殊权限说明

### 1. 汇报关系管理
- 只有项目管理员可以设置汇报关系
- 上级的角色优先级必须高于下属
- 不能形成循环汇报关系

### 2. 自定义角色
- 项目支持自定义角色名称（1-30个字符）
- 自定义角色默认权限级别为 member（优先级 4）

### 3. 管理员树视图
- **owner, director**: 可以访问并编辑
- **manager**: 可以访问但只读（了解团队情况）
- 包括：成员任务树、项目总览等全局视图

### 4. AI 功能权限
- **AI 全局分析**：仅 owner、director
- **AI 项目分析**：owner、director、manager（只能分析自己负责的项目）
- **AI 任务分析**：所有成员（owner、director、manager、member）
- **AI 洞察查看**：owner、director、manager

---

## 权限配置位置

### 前端配置
- 文件：`frontend/src/config/permissions.ts`
- 包含所有权限定义和检查函数

### 后端配置
- 工作区角色：`backend/src/repositories/workspaceRepository.ts`
- 项目角色：`backend/src/services/adminService.ts`
- 权限检查：`backend/src/services/adminService.ts`、`backend/src/services/workspaceService.ts`、`backend/src/services/taskService.ts`、`backend/src/services/projectService.ts`

---

## 角色显示名称

| 角色代码 | 显示名称 | 描述 |
|---------|---------|------|
| owner | 掌门 | 公司所有者，拥有最终决策权，可管理所有设置和成员 |
| director | 长老 | 管理多个团队，有招聘和部分解雇权，可查看全局分析 |
| manager | 堂主 | 管理一个团队，可以招人，负责项目交付，可查看团队数据 |
| member | 弟子 | 执行具体工作，对自己的任务负责，可以提建议 |
| observer | 俗客 | 临时参与者，主要是了解情况、学习或提供建议 |
| project_admin / lead | 项目负责人 | 负责项目整体进度和团队管理 |
| team_lead / senior | 核心成员 | 可分配任务，协助管理团队 |
| member | 项目成员 | 参与项目任务执行 |

---

*最后更新：2025年1月 - 真实世界组织架构权限设计*
